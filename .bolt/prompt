# NatureUP Health — Updated Bolt Project Instructions

This project workflow is **Bolt.new → GitHub Repository → Bolt Database (edge functions) → launch.expo.dev → EAS Build**.  
There are no local files; everything is handled in the cloud.

The bundle ID is: **com.natureup.health41**

---

## NatureUP Health - Architecture & Workflow

### Project Overview

NatureUP Health is a voice-first, mobile health app focused on personalized outdoor excursions and nature therapy. The app provides real-time wellness guidance through AI-powered coaching and generates custom nature therapy routes.

---

## Platform & Deployment

- **Primary Platform**: iOS (production)
- **Development Preview**: Web (Bolt.new preview only)
- **Development Workflow**: Bolt.new → GitHub → launch.expo.dev → EAS Build
- **Distribution**: TestFlight → App Store

---

## Tech Stack

### Core Framework

- **Expo SDK 54** - React Native framework
- **React Native 0.76.5** - Mobile UI framework
- **TypeScript** - Type safety
- **expo-router v4** - File-based routing

### Backend & Data

- **Supabase (Primary DB)**  
  - Authentication & PostgreSQL database  
  - All app tables live here: `user_profiles`, `excursions`, `conversations`, `favorite_excursions`, etc.  
  - RLS policies and `auth.users` are defined in Supabase.

- **Bolt Database (Functions + Secrets Only)**  
  - Hosts edge functions: `health-coach`, `excursion-engine`/`excursion-creator`, `save-excursion`, etc.  
  - Stores environment secrets:  
    - `SUPABASE_URL` (Supabase project URL)  
    - `SUPABASE_SERVICE_ROLE_KEY` (service-role key from the same Supabase project)  
    - `OPENAI_API_KEY`  
    - `HEALTH_COACH_ASSISTANT_ID`  
    - `EXCURSION_ENGINE_ASSISTANT_ID`  

  Bolt Database is **not** used as an application data store.  
  All reads/writes go through Supabase, even when executed inside Bolt functions.

- **OpenAI Assistants API**  
  - AI-powered coaching and excursion planning  
  - Uses **Assistants API** with tools/function calling (NOT Chat Completions).

### UI & Interaction

- **StyleSheet.create()** - React Native styling (no NativeWind/Tailwind)
- **lucide-react-native** - Icons
- **react-native-maps** - iOS maps (with graceful web fallback)
- **Voice Interface (future)** - Primary interaction method; text is the current interaction surface and remains the fallback.

---

## Backend & Database Architecture (Important for Bolt)

### Single Source of Truth

- Supabase is the **only** canonical database for user data and app state.
- Bolt Database is treated as:
  - Edge function runtime
  - Secret store

### Supabase Client Pattern in Edge Functions

Every edge function that needs DB access must create a Supabase client using Bolt’s secrets:

```ts
import { createClient } from "npm:@supabase/supabase-js@2";

const supabase = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);
```

No edge function should connect directly to Bolt’s internal Postgres for app tables.

### Edge Functions & Auth

- Functions run in Bolt Database with `verify_jwt: true` where user context is required.
- The React Native app passes the Supabase **session access token** in the `Authorization` header:

```http
Authorization: Bearer <supabase_session_jwt>
```

- Functions resolve the current user via:

```ts
const { data: authData, error: authError } = await supabase.auth.getUser(jwt);
const userId = authData?.user?.id;
```

- Request bodies may include `userId`, but the authenticated user (`auth.uid()`) is the source of truth. The function should validate that body.userId (if present) matches the authenticated user.

---

## AI Architecture

### Two OpenAI Assistants (Assistants API)

#### 1. Health Coach Assistant

- **Purpose**: General wellness and nature-therapy coaching.
- **Role**: The **only** assistant that conceptually “talks” to the user.
- **Tools**:
  - `create_excursion` — to request excursions from the Excursion Engine via the backend.
  - `coach_user` — to generate structured coaching steps/prompts.

All Health Coach interactions from the app go through the **`health-coach` edge function**, which then calls the Assistants API.

#### 2. Excursion Engine Assistant

- **Purpose**: Generate 1–3 structured nature therapy routes.
- **Tools**:
  - `plan_excursion` — must always return options with ordered waypoints and timing.
- **Constraints**:
  - File Search and Code Interpreter are OFF.
  - It never returns natural-language text; only tool calls / structured JSON.

Health Coach uses `create_excursion` (in the backend) to trigger `plan_excursion` on this assistant.

---

## Development Workflow

### 1. Development in Bolt.new

- All code authored in Bolt.new.
- When changes are saved, Bolt commits to GitHub automatically.
- Edge function source is under `supabase/functions/*`.

### 2. Edge Function Deployment (Bolt Database)

1. Open Bolt Database → **Edge Functions**.
2. For each function (`health-coach`, `excursion-engine` or `excursion-creator`, `save-excursion`):
   - Ensure the source folder matches `supabase/functions/<name>` in the GitHub repo.
   - Deploy from the desired branch (usually `main`).
3. After deployment, test each endpoint using the Bolt UI or Thunder Client:
   - `POST /functions/v1/health-coach`
   - `POST /functions/v1/excursion-engine` (or `/excursion-creator`)
   - `POST /functions/v1/save-excursion`

### 3. Preview on iPhone

1. Push code from Bolt.new → GitHub (automatic).
2. Visit **launch.expo.dev**.
3. Paste the GitHub repo URL.
4. Scan the QR code with the iPhone camera.
5. The build opens in the Expo Go app.

### 4. Production Builds

```bash
# EAS Build for TestFlight
eas build --platform ios --profile preview

# Submit to TestFlight
eas submit --platform ios
```

---

## Database Schema (Supabase PostgreSQL)

The tables and RLS rules remain as in the prior instructions:

- `user_profiles`
- `excursions`
- `conversations`
- `favorite_excursions`

Each table:

- Uses `snake_case`.
- Has RLS enabled with policies based on `auth.uid()`.
- Has appropriate indexes (`user_id`, `thread_id`, etc.).

(Original per-table descriptions can stay as-is; they do not change for this update.)

---

## API Key Management

### Server-side (Bolt Database + Supabase)

Sensitive keys are stored **only** in server environments:

- `OPENAI_API_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `HEALTH_COACH_ASSISTANT_ID`
- `EXCURSION_ENGINE_ASSISTANT_ID`
- Any other third-party API keys

### Client Environment Variables

Only public keys:

```bash
EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

No private keys in client `.env`.

---

## Design System, Coding Standards, and Other Sections

All existing sections for:

- Color palette
- Typography
- Components
- Naming conventions
- File organization
- Build configuration
- Deployment checklist
- UX / performance / security best practices

remain valid and can be kept unchanged.  
The key updates in this document are:

1. Explicit **Supabase vs Bolt Database separation**.
2. Clear **edge function deployment** workflow.
3. Clarified **AI architecture** (Health Coach vs Excursion Engine) and their use from the backend.

---